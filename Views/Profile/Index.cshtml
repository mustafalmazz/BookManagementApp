@using BookManagementApp.Areas.Admin.Models
@model UserProfileViewModel
@{
    ViewData["Title"] = "Profil Özetim";

    int progressPercentage = Model.YearlyReadingGoal > 0
        ? Math.Min(100, (int)((double)Model.BooksReadThisYear / Model.YearlyReadingGoal * 100))
        : 0;
}

<style>
    /* --- MEVCUT STİLLER (KORUNDU) --- */
    body {
        background: linear-gradient(135deg, #f5f0e8 0%, #e8dcc8 100%);
        font-family: 'Georgia', serif;
        color: #4a3f35;
    }

    .profile-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .profile-header-card {
        background: #fff9f0;
        border-radius: 20px;
        padding: 30px;
        display: flex;
        align-items: center;
        gap: 30px;
        box-shadow: 0 10px 30px rgba(107, 85, 65, 0.15);
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
    }

        .profile-header-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(180deg, #8b6f47, #6b5541);
        }

    .profile-info h1 {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 5px;
        color: #4a3f35;
    }

    .profile-info p {
        color: #8b6f47;
        font-size: 1.1rem;
        margin: 0;
        font-style: italic;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 25px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: #fff;
        border-radius: 20px;
        padding: 25px;
        position: relative;
        box-shadow: 0 5px 20px rgba(107, 85, 65, 0.1);
        transition: transform 0.3s ease;
        overflow: hidden;
        border: 1px solid rgba(139, 111, 71, 0.1);
    }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(107, 85, 65, 0.2);
            border-color: #8b6f47;
        }

    .stat-icon-bg {
        position: absolute;
        top: -20px;
        right: -20px;
        font-size: 8rem;
        opacity: 0.05;
        color: #4a3f35;
        transform: rotate(15deg);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .card-book .stat-icon {
        background: linear-gradient(135deg, #8b6f47, #6b5541);
        color: #fff;
    }

    .card-cat .stat-icon {
        background: linear-gradient(135deg, #a0785a, #8b6f47);
        color: #fff;
    }

    .card-page .stat-icon {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: #fff;
    }

    .card-money .stat-icon {
        background: linear-gradient(135deg, #ecc94b, #d69e2e);
        color: #fff;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #8b6f47;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #4a3f35;
        margin-top: 5px;
    }

    .stat-sub {
        font-size: 0.8rem;
        color: #999;
        margin-top: 5px;
    }

    .bottom-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }

    .feature-card {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        border: 2px solid rgba(139, 111, 71, 0.1);
    }

    .feature-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #4a3f35;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .progress-container {
        background: #e8dcc8;
        border-radius: 15px;
        height: 25px;
        overflow: hidden;
        margin-bottom: 10px;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
    }

    .progress-bar-custom {
        background: linear-gradient(90deg, #8b6f47, #a0785a);
        height: 100%;
        border-radius: 15px;
        text-align: center;
        color: #fff;
        font-size: 0.85rem;
        font-weight: 600;
        line-height: 25px;
        transition: width 1s ease-in-out;
        width: 0%;
    }

    .quote-box {
        font-style: italic;
        color: #6b5541;
        font-size: 1.1rem;
        text-align: center;
        padding: 20px;
        background: #fff9f0;
        border-radius: 15px;
        border-left: 4px solid #8b6f47;
    }

    /* --- AVATAR & MODAL STİLLERİ --- */

    .avatar-wrapper {
        position: relative;
        width: 120px;
        height: 120px;
        flex-shrink: 0;
        cursor: pointer;
    }

    .profile-avatar {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #fff9f0 0%, #e6dac8 100%);
        color: #5c4b3d;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3.5rem;
        font-weight: 700;
        box-shadow: 0 5px 15px rgba(107, 85, 65, 0.15);
        border: 4px solid #fff;
        overflow: hidden;
    }

        .profile-avatar img {
            width: 95%;
            height: 95%;
            object-fit: cover;
        }

    .avatar-edit-overlay {
        position: absolute;
        bottom: 0;
        right: 0;
        background: #4a3f35;
        color: #fff;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #fff9f0;
        transition: all 0.3s ease;
        opacity: 0.9;
    }

    .avatar-wrapper:hover .avatar-edit-overlay {
        transform: scale(1.1);
        background: #a0785a;
    }

    .custom-modal-content {
        background: #fff9f0;
        border-radius: 20px;
        border: none;
    }

    .modal-header {
        border-bottom: 1px solid rgba(139, 111, 71, 0.2);
    }

    .modal-title {
        color: #4a3f35;
        font-weight: 700;
        font-family: 'Georgia', serif;
    }

    .nav-tabs .nav-link {
        color: #8b6f47;
        font-weight: 600;
        border: none;
        background: transparent;
    }

        .nav-tabs .nav-link.active {
            color: #4a3f35;
            background: transparent;
            border-bottom: 3px solid #a0785a;
        }

    .avatar-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        padding: 20px 0;
    }

    .avatar-option {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.2s ease;
        object-fit: cover;
    }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: #a0785a;
            box-shadow: 0 0 10px rgba(160, 120, 90, 0.5);
            transform: scale(1.1);
        }

    .btn-save-custom {
        background: linear-gradient(135deg, #8b6f47, #6b5541);
        color: #fff;
        border-radius: 20px;
        padding: 8px 25px;
        border: none;
    }

        .btn-save-custom:hover {
            background: linear-gradient(135deg, #a0785a, #8b6f47);
            color: #fff;
        }

    /* ============================================
           RESPONSIVE - TABLET & MOBILE
           ============================================ */

    /* Tablet - 992px ve altı */
    @@media (max-width: 992px) {
        .stats-grid

    {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        padding: 20px;
    }

    .stat-value {
        font-size: 2.2rem;
    }

    .stat-icon {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
    }

    .bottom-grid {
        gap: 25px;
    }

    .feature-card {
        padding: 25px;
    }

    .feature-title {
        font-size: 1.3rem;
    }

    }

    /* Mobile - 768px ve altı */
    @@media (max-width: 768px) {
        .profile-container

    {
        margin: 20px auto;
        padding: 0 15px;
    }

    /* Header Card - Mobile */
    .profile-header-card {
        flex-direction: column;
        text-align: center;
        padding: 25px 20px;
        border-radius: 15px;
        margin-bottom: 25px;
    }

        .profile-header-card::before {
            width: 100%;
            height: 6px;
            left: 0;
            top: 0;
            bottom: auto;
            right: 0;
        }

    .avatar-wrapper {
        margin-bottom: 15px;
        width: 100px;
        height: 100px;
    }

    .profile-avatar {
        font-size: 3rem;
        border: 3px solid #fff;
    }

    .avatar-edit-overlay {
        width: 32px;
        height: 32px;
        font-size: 0.85rem;
    }

    .profile-info h1 {
        font-size: 1.5rem;
        margin-bottom: 8px;
    }

    .profile-info p {
        font-size: 0.95rem;
    }

    /* ✨ Stats Grid - Mobile (2x2 Düzen) ✨ */
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 25px;
    }

    .stat-card {
        padding: 18px 15px;
        border-radius: 15px;
    }

        .stat-card:hover {
            transform: translateY(-3px);
        }

    .stat-icon-bg {
        font-size: 4.5rem;
        top: -8px;
        right: -8px;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
        margin-bottom: 10px;
        border-radius: 10px;
    }

    .stat-label {
        font-size: 0.7rem;
        letter-spacing: 0.3px;
    }

    .stat-value {
        font-size: 1.6rem;
        margin-top: 2px;
    }

    .stat-sub {
        font-size: 0.68rem;
        margin-top: 2px;
        line-height: 1.2;
    }

    /* Bottom Grid - Mobile */
    .bottom-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .feature-card {
        padding: 20px;
        border-radius: 15px;
    }

    .feature-title {
        font-size: 1.15rem;
        margin-bottom: 15px;
        gap: 8px;
    }

        .feature-title i {
            font-size: 1rem;
        }

    /* Progress Bar - Mobile */
    .progress-container {
        height: 22px;
        border-radius: 12px;
        margin-bottom: 8px;
    }

    .progress-bar-custom {
        font-size: 0.75rem;
        line-height: 22px;
        border-radius: 12px;
    }

    .d-flex.justify-content-between.mb-2 {
        font-size: 0.9rem;
    }

        .d-flex.justify-content-between.mb-2 span {
            font-size: 0.95rem;
        }

    /* Quote Box - Mobile */
    .quote-box {
        font-size: 0.95rem;
        padding: 15px;
        border-radius: 12px;
        border-left-width: 3px;
    }

        .quote-box span {
            font-size: 0.75rem;
            margin-top: 3px;
        }

    .feature-card h3 {
        font-size: 1.6rem !important;
        margin-bottom: 15px !important;
    }

    /* Modal - Mobile */
    .modal-dialog {
        margin: 10px;
    }

    .custom-modal-content {
        border-radius: 15px;
    }

    .modal-header {
        padding: 15px 20px;
    }

    .modal-title {
        font-size: 1.1rem;
    }

    .modal-body {
        padding: 15px 20px;
    }

    .modal-footer {
        padding: 12px 20px;
    }

    .nav-tabs .nav-link {
        font-size: 0.9rem;
        padding: 8px 12px;
    }

    .avatar-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 15px 0;
    }

    .avatar-option {
        width: 60px;
        height: 60px;
        border-width: 2px;
    }

    #uploadPreview {
        width: 80px !important;
        height: 80px !important;
    }

    .btn-save-custom {
        padding: 10px 20px;
        font-size: 0.9rem;
    }

    /* Goal Modal - Mobile */
    #newGoalInput {
        font-size: 1.1rem;
        padding: 10px;
    }

    }

    /* Extra Small Mobile - 480px ve altı */
    @@media (max-width: 480px) {
        .profile-container

    {
        padding: 0 12px;
        margin: 15px auto;
    }

    .profile-header-card {
        padding: 20px 15px;
    }

    .profile-info h1 {
        font-size: 1.35rem;
    }

    .profile-info p {
        font-size: 0.85rem;
    }

    .avatar-wrapper {
        width: 90px;
        height: 90px;
    }

    .profile-avatar {
        font-size: 2.5rem;
    }

    /* ✨ Stats Grid - Extra Small (2x2 Düzen - Daha Kompakt) ✨ */
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .stat-card {
        padding: 15px 12px;
    }

    .stat-icon-bg {
        font-size: 4rem;
        top: -6px;
        right: -6px;
    }

    .stat-icon {
        width: 36px;
        height: 36px;
        font-size: 1rem;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 0.65rem;
    }

    .stat-value {
        font-size: 1.4rem;
    }

    .stat-sub {
        font-size: 0.62rem;
    }

    .feature-card {
        padding: 18px 15px;
    }

    .feature-title {
        font-size: 1.05rem;
    }

    .feature-card h3 {
        font-size: 1.4rem !important;
    }

    .quote-box {
        font-size: 0.85rem;
        padding: 12px;
    }

    .avatar-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .avatar-option {
        width: 55px;
        height: 55px;
    }

    .d-flex.justify-content-between.mb-2 {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 5px;
    }

        .d-flex.justify-content-between.mb-2 > div {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

    }

    /* Landscape Mobile için ek düzenleme */
    @@media (max-width: 768px) and (orientation: landscape) {
        .stats-grid

    {
        grid-template-columns: repeat(2, 1fr);
    }

    .bottom-grid {
        grid-template-columns: 1fr 1fr;
    }

    .profile-header-card {
        flex-direction: row;
        text-align: left;
    }

        .profile-header-card::before {
            width: 6px;
            height: 100%;
            top: 0;
            bottom: 0;
            left: 0;
        }

    .avatar-wrapper {
        margin-bottom: 0;
    }

    }
</style>

<div class="profile-container">

    <div class="profile-header-card">
        <div class="avatar-wrapper" data-bs-toggle="modal" data-bs-target="#avatarModal">
            <div class="profile-avatar" id="currentProfileAvatar">
                @if (!string.IsNullOrEmpty(Model.ProfileImageUrl))
                {
                    <img src="@Model.ProfileImageUrl" alt="Profil Fotoğrafı">
                }
                else
                {
                    @Model.UserName.Substring(0, 1).ToUpper()
                }
            </div>
            <div class="avatar-edit-overlay">
                <i class="fa-solid fa-camera"></i>
            </div>
        </div>

        <div class="profile-info">
            <h1>Merhaba, @Model.UserName</h1>
            <p>
                <i class="fa-solid fa-calendar-check"></i>
                @Model.JoinDate.ToString("MMMM yyyy") tarihinden beri üyesiniz.
            </p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card card-book">
            <i class="fa-solid fa-book stat-icon-bg"></i>
            <div class="stat-icon"><i class="fa-solid fa-book-open"></i></div>
            <div class="stat-label">Toplam Kitap</div>
            <div class="stat-value">@Model.TotalBooks</div>
            <div class="stat-sub">Kütüphanendeki eserler</div>
        </div>
        <div class="stat-card card-cat">
            <i class="fa-solid fa-tags stat-icon-bg"></i>
            <div class="stat-icon"><i class="fa-solid fa-layer-group"></i></div>
            <div class="stat-label">Kategori</div>
            <div class="stat-value">@Model.TotalCategories</div>
            <div class="stat-sub">Farklı türde okumalar</div>
        </div>
        <div class="stat-card card-page">
            <i class="fa-solid fa-scroll stat-icon-bg"></i>
            <div class="stat-icon"><i class="fa-solid fa-file-lines"></i></div>
            <div class="stat-label">Toplam Sayfa</div>
            <div class="stat-value">@Model.TotalPagesRead.ToString("N0")</div>
            <div class="stat-sub">Kelime kelime bilgi</div>
        </div>
        <div class="stat-card card-money">
            <i class="fa-solid fa-coins stat-icon-bg"></i>
            <div class="stat-icon"><i class="fa-solid fa-turkish-lira-sign"></i></div>
            <div class="stat-label">Yatırım</div>
            <div class="stat-value">@Model.TotalMoneySpent.ToString("N0") ₺</div>
            <div class="stat-sub">Kitaplara yapılan yatırım</div>
        </div>
    </div>

    <div class="bottom-grid">
        <div class="feature-card">
            <div class="feature-title"><i class="fa-solid fa-bullseye" style="color: #a0785a;"></i> Yıllık Okuma Hedefi</div>

            <div class="d-flex justify-content-between mb-2 align-items-center">
                <span style="font-weight:bold; color:#4a3f35;">@Model.BooksReadThisYear Kitap</span>
                <div style="color:#8b6f47;">
                    Hedef: @if (Model.YearlyReadingGoal == 0)
                    {
                        <text><i>Belirlenmedi</i></text>
                    }
                    else
                    {
                        @Model.YearlyReadingGoal
                    }
                    <a href="javascript:void(0)" class="ms-2" style="color: #a0785a; text-decoration: none;" data-bs-toggle="modal" data-bs-target="#goalModal">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </a>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar-custom" id="goalProgressBar" data-width="@progressPercentage%">@progressPercentage%</div>
            </div>

            <p style="font-size:0.9rem; color:#666; margin-top:10px;">
                @if (progressPercentage == 0)
                {
                    <i>"Hedefi Olmayan Gemiye Hiçbir Rüzgar Yardım Etmez..."</i>
                }
                else
                {
                    @(progressPercentage >= 100 ? "Tebrikler! Yıllık hedefini tamamladın! ✅" : "Harika gidiyorsun, okumaya devam! 📚")
                }

            </p>
        </div>
        <div class="feature-card">
            <div class="feature-title"><i class="fa-solid fa-heart" style="color: #a0785a;"></i> Favori Türün</div>
            <h3 style="font-size:2rem; color:#8b6f47; font-weight:800; margin-bottom:20px;">
                @(string.IsNullOrEmpty(Model.FavoriteCategory) ? "Henüz Belirlenmedi" : Model.FavoriteCategory)
            </h3>
            <div class="quote-box">"Kitaplar, ruhun aynasıdır." <br><span style="font-size:0.8rem; display:block; margin-top:5px;">- Virginia Woolf</span></div>
        </div>
    </div>
</div>

<div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="avatarModalLabel"><i class="fa-solid fa-user-pen"></i> Profil Fotoğrafı Seç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="avatarTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="select-tab" data-bs-toggle="tab" data-bs-target="#select-pane" type="button" role="tab">Hazır Avatar</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button" role="tab">Fotoğraf Yükle</button>
                    </li>
                </ul>

                <div class="tab-content" id="avatarTabsContent">
                    <div class="tab-pane fade show active" id="select-pane" role="tabpanel">
                        <div class="text-center mb-2 text-muted small">Bir karakter seç:</div>
                        <div class="avatar-grid">
                            <img src="https://cdn-icons-png.flaticon.com/512/3906/3906607.png " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/4042/4042356.png" class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/523/523461.png " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/4086/4086679.png" class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/4042/4042422.png" class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/4086/4086577.png" class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/189/189162.png " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/4322/4322991.png" class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/4140/4140047.png" class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/8854/8854242.png " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/17715/17715285.png " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/8231/8231329.png " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/1326/1326377.png  " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/9308/9308979.png  " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/780/780258.png  " class="avatar-option" onclick="selectAvatar(this)">
                            <img src="https://cdn-icons-png.flaticon.com/512/624/624150.png   " class="avatar-option" onclick="selectAvatar(this)">
                        </div>
                    </div>

                    <div class="tab-pane fade" id="upload-pane" role="tabpanel">
                        <div class="mb-3 text-center">
                            <label for="customAvatarFile" class="form-label text-muted">Bilgisayarından bir fotoğraf seç</label>
                            <input class="form-control" type="file" id="customAvatarFile" accept="image/*">
                        </div>
                        <div class="text-center mt-3">
                            <div id="uploadPreview" style="width: 100px; height: 100px; border-radius: 50%; background: #e8dcc8; margin: 0 auto; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                <span class="text-muted small">Önizleme</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: none;">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-sm btn-save-custom" id="saveAvatarBtn">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="goalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content custom-modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fs-6">Yıllık Hedefi Düzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="number" id="newGoalInput" class="form-control text-center" value="@Model.YearlyReadingGoal" min="1" max="1000">
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-sm btn-save-custom w-100" id="saveGoalBtn">Güncelle</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        setTimeout(function() {
            const bar = document.getElementById('goalProgressBar');
            if(bar) bar.style.width = bar.getAttribute('data-width');
        }, 300);
    });

    // --- AVATAR İŞLEMLERİ (MEVCUT) ---
    let selectedAvatarUrl = "";
    let uploadedFile = null;

    function selectAvatar(imgElement) {
        document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
        imgElement.classList.add('selected');
        selectedAvatarUrl = imgElement.src;
        uploadedFile = null;
    }

    document.getElementById('customAvatarFile').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            uploadedFile = file;
            selectedAvatarUrl = "";
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('uploadPreview').innerHTML = `<img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
            }
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('saveAvatarBtn').addEventListener('click', function() {
        const formData = new FormData();
        if (uploadedFile) {
            formData.append('file', uploadedFile);
        } else if (selectedAvatarUrl) {
            formData.append('avatarUrl', selectedAvatarUrl);
        } else {
            alert("Lütfen bir avatar seçin veya fotoğraf yükleyin.");
            return;
        }

        const btn = this;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Kaydediliyor...';
        btn.disabled = true;

        fetch('/Profile/UpdateAvatar', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("Hata: " + data.message);
                btn.innerHTML = 'Kaydet';
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert("Bir hata oluştu.");
            btn.innerHTML = 'Kaydet';
            btn.disabled = false;
        });
    });

    // --- HEDEF GÜNCELLEME İŞLEMİ ---
    document.getElementById('saveGoalBtn').addEventListener('click', function() {
        // 1. Değeri al
        const newGoal = document.getElementById('newGoalInput').value;

        // 2. Kontrol et
        if(newGoal < 1) {
            alert("Lütfen geçerli bir hedef giriniz.");
            return;
        }

        // 3. Butonu kilitle
        const btn = this;
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ...';
        btn.disabled = true;

        // 4. VERİYİ HAZIRLA (Controller [FromForm] beklediği için URLSearchParams kullanıyoruz)
        const formData = new URLSearchParams();
        formData.append('goal', newGoal);

        // 5. Gönder
        fetch('/Profile/UpdateGoal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded' // ÖNEMLİ: Form formatı
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Başarılıysa sayfayı yenile
            } else {
                alert("Hata: " + data.message);
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert("Bir bağlantı hatası oluştu.");
            btn.innerHTML = oldText;
            btn.disabled = false;
        });
    });
</script>